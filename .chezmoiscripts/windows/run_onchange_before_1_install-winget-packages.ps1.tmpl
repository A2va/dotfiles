Set-StrictMode -Version 3.0
$ErrorActionPreference = "Stop"
{{ $winget_packages := concat
  (dig "all" list .packages.winget) -}}
  # (dig .profile list .packages.winget) -}}

#region Winget packages
{{ $winget_list := (output "cmd" "/C" "winget export -s winget -o %TEMP%\\winget_list && type %TEMP%\\winget_list") -}}
{{ range $winget_packages -}}
{{   if not (contains . $winget_list) -}}
        Write-Host Installing winget package '{{ .}}'
        winget install `
          --scope user --exact --source winget --id {{ . }} `
          --accept-source-agreements `
          --accept-package-agreements `
          --silent `
          --disable-interactivity
{{   end -}}
{{ end }}
#endregion

# xmake can't be installed like the other packages, because if it installed like the others, xrepo
# isn't available.
winget install --id Xmake-io.Xmake --interactive


# If in Windows PowerShell (Desktop edition), remove any PS7 paths:
if ($PSVersionTable.PSEdition -eq 'Desktop') {
    $mydocuments = [environment]::getfolderpath("mydocuments")
    $userPath = Join-Path $mydocuments 'Documents\WindowsPowerShell\Modules'

    $programFiles = "$env:ProgramFiles\WindowsPowerShell\Modules"
    $systemPath   = "$env:WINDIR\System32\WindowsPowerShell\v1.0\Modules"

    # Set PSModulePath to match normal PS 5.1 session
    $Env:PSModulePath = "$userPath;$programFiles;$systemPath"

    Write-Host "Corrected PSModulePath for Windows PowerShell:"
}

# Install PSFzf module for fuzzy finding in PowerShell
Import-Module PackageManagement
Import-Module PowerShellGet
Install-Module -Name PSFzf -Scope CurrentUser